<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TasteDash Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .screen { display: none; }
        .screen.active { display: block; }
        h1, h2 { color: #333; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 16px; }
        .tab-button.active { border-bottom: 3px solid #FFC72C; font-weight: 600; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; vertical-align: middle; }
        th { background-color: #f8f8f8; }
        .btn, button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; background-color: #FFC72C; font-weight: 600; font-size: 14px; margin-right: 5px; }
        .btn-danger { background-color: #e74c3c; color: white; }
        .form-section { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .form-section h2 { margin-top: 0; }
        input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        #login-form-container { max-width: 400px; margin: 50px auto; }
    </style>
</head>
<body>

<div id="auth-screen" class="screen active">
    <div id="login-form-container" class="container">
        <form id="login-form">
            <h2>Admin Login</h2>
            <input type="email" id="login-email" placeholder="Email" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button type="submit" class="btn">Login</button>
            <p id="login-error" style="color:red;"></p>
        </form>
    </div>
</div>

<div id="admin-panel-screen" class="screen">
    <div class="container">
        <h1>TasteDash Admin Panel</h1>
        <button onclick="logout()" style="float: right;">Logout</button>
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('products')">Manage Products</button>
            <button class="tab-button" onclick="showTab('orders')">View Orders</button>
        </div>

        <!-- Products Tab -->
        <div id="products-tab" class="tab-content active">
            <div class="form-section">
                <h2 id="form-title">Add New Product</h2>
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    <input type="text" id="product-name" placeholder="Product Name" required>
                    <textarea id="product-description" placeholder="Description"></textarea>
                    <input type="number" id="product-price" placeholder="Price" step="0.01" required>
                    <input type="url" id="product-image-url" placeholder="Image URL (e.g., from Pexels)" required>
                    <button type="submit" class="btn">Save Product</button>
                    <button type="button" onclick="resetForm()">Cancel</button>
                </form>
            </div>
            <h2>Existing Products</h2>
            <table id="products-table">
                <thead><tr><th>Image</th><th>Name</th><th>Price</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Orders Tab -->
        <div id="orders-tab" class="tab-content" style="display:none;">
            <h2>Customer Orders</h2>
            <table id="orders-table">
                <thead><tr><th>Order ID</th><th>Date</th><th>Customer Email</th><th>Total</th><th>Status</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://nnzxcmiorujpxgnmxnkk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uenhjbWlvcnVqcHhnbm14bmtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNDUyMjYsImV4cCI6MjA3MjgyMTIyNn0.sNP3nCNOgCU6ujHU_4orPb9k1exhjmAWvgv-Q9STdUw';
    
    // CORRECTED: Initialize the client correctly
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- AUTH ---
    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            showScreen('admin-panel');
            loadProducts();
            loadOrders();
        } else {
            showScreen('auth');
        }
    });

    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) document.getElementById('login-error').textContent = error.message;
        else window.location.reload(); 
    });

    async function logout() {
        await supabaseClient.auth.signOut();
        window.location.reload();
    }

    // --- NAVIGATION ---
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(`${screenId}-screen`).classList.add('active');
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${tabId}-tab`).style.display = 'block';
        document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
    }

    // --- PRODUCTS MANAGEMENT ---
    const productForm = document.getElementById('product-form');
    const productsTableBody = document.querySelector('#products-table tbody');

    async function loadProducts() {
        const { data, error } = await supabaseClient.from('products').select('*').order('created_at');
        if (error) return console.error(error);
        productsTableBody.innerHTML = '';
        data.forEach(p => {
            productsTableBody.innerHTML += `
                <tr>
                    <td><img src="${p.image_url}" alt="${p.name}" width="60" height="60" style="object-fit: cover; border-radius: 4px;"></td>
                    <td>${p.name}</td>
                    <td>$${Number(p.price).toFixed(2)}</td>
                    <td>
                        <button onclick='editProduct(${JSON.stringify(p)})'>Edit</button>
                        <button class="btn-danger" onclick="deleteProduct(${p.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    }

    productForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const productData = {
            name: document.getElementById('product-name').value,
            description: document.getElementById('product-description').value,
            price: document.getElementById('product-price').value,
            image_url: document.getElementById('product-image-url').value
        };
        const id = document.getElementById('product-id').value;
        
        const { error } = id
            ? await supabaseClient.from('products').update(productData).eq('id', id)
            : await supabaseClient.from('products').insert([productData]);
        
        if (error) alert('Error saving product: ' + error.message);
        else {
            resetForm();
            loadProducts();
        }
    });
    
    function editProduct(product) {
        document.getElementById('form-title').textContent = 'Edit Product';
        document.getElementById('product-id').value = product.id;
        document.getElementById('product-name').value = product.name;
        document.getElementById('product-description').value = product.description;
        document.getElementById('product-price').value = product.price;
        document.getElementById('product-image-url').value = product.image_url;
        window.scrollTo(0, 0);
    }
    
    async function deleteProduct(id) {
        if (!confirm('Are you sure you want to delete this product?')) return;
        const { error } = await supabaseClient.from('products').delete().eq('id', id);
        if (error) alert('Error deleting product: ' + error.message);
        else loadProducts();
    }
    
    function resetForm() {
        productForm.reset();
        document.getElementById('form-title').textContent = 'Add New Product';
        document.getElementById('product-id').value = '';
    }

    // --- ORDERS MANAGEMENT ---
    async function loadOrders() {
        const { data, error } = await supabaseClient.from('orders').select('*').order('created_at', { ascending: false });
        if (error) return console.error('Error fetching orders:', error);
        
        const ordersTableBody = document.querySelector('#orders-table tbody');
        ordersTableBody.innerHTML = '';
        data.forEach(order => {
            ordersTableBody.innerHTML += `
                <tr>
                    <td>${order.id}</td>
                    <td>${new Date(order.created_at).toLocaleString()}</td>
                    <td>${order.user_email || 'N/A'}</td>
                    <td>$${Number(order.total_price).toFixed(2)}</td>
                    <td>${order.status}</td>
                </tr>
            `;
        });
    }
</script>
</body>
</html>