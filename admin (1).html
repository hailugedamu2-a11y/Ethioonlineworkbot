<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Dream Wallet BD</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root{--primary:#00d2ff;--secondary:#924eff;--accent:#ff0055;--bg-color:#0f172a;--card-bg:rgba(255,255,255,0.08);--border:rgba(255,255,255,0.15)}
        body{font-family:'Hind Siliguri',sans-serif;background:#1a1a2e;background-image:linear-gradient(to bottom,rgba(26,26,46,0.9),rgba(22,33,62,0.95)),url('https://img.freepik.com/free-vector/gradient-network-connection-background_23-2148879890.jpg');background-size:cover;background-attachment:fixed;background-position:center;color:#fff;min-height:100vh;overflow-x:hidden;padding-bottom:100px;user-select:none;-webkit-tap-highlight-color:transparent}
        .glass-card{background:var(--card-bg);backdrop-filter:blur(25px);-webkit-backdrop-filter:blur(25px);border:1px solid var(--border);border-radius:24px;box-shadow:0 8px 32px 0 rgba(0,0,0,0.3);transition:transform .2s,box-shadow .2s}
        .text-grad{background:linear-gradient(90deg,#00d2ff,#924eff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:700}
        .btn-modern{background:linear-gradient(135deg,#00d2ff 0%,#3a7bd5 100%);border:none;color:white;font-weight:600;border-radius:16px;box-shadow:0 4px 15px rgba(0,210,255,0.3);position:relative;overflow:hidden; cursor: pointer;}
        .glass-nav{background:rgba(26,26,46,0.9);backdrop-filter:blur(20px);border-top:1px solid var(--border);border-radius:24px 24px 0 0;box-shadow:0 -5px 20px rgba(0,0,0,0.5)}
        .nav-item{color:#8a8aa0;transition:.3s; text-align: center; cursor: pointer;}
        .nav-item.active{color:var(--primary);transform:translateY(-5px);text-shadow:0 0 10px rgba(0,210,255,0.5)}
        .custom-input{background:rgba(0,0,0,0.3);border:1px solid var(--border);color:white;transition:.3s}
        #progressRing { transition: stroke-dashoffset 0.3s ease; }
        .hide-scrollbar::-webkit-scrollbar{display:none}
    </style>
</head>
<body>
    <!-- LOADING SCREEN -->
    <div id="loadingScreen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-[#1a1a2e]">
        <div class="relative w-24 h-24 mb-4">
            <svg class="w-full h-full transform -rotate-90">
                <circle cx="48" cy="48" r="40" stroke="#333" stroke-width="8" fill="transparent" />
                <circle id="progressRing" cx="48" cy="48" r="40" stroke="#00d2ff" stroke-width="8" fill="transparent" stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round" />
            </svg>
            <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                <span id="loadingPercent" class="text-xl font-bold text-white">0%</span>
            </div>
        </div>
        <h2 class="text-[#00d2ff] font-bold tracking-widest text-sm animate-pulse">SYSTEM LOADING...</h2>
    </div>

    <!-- Multi-Channel Verification Gate -->
    <div id="gateScreen" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center p-6 bg-black/95 backdrop-blur-xl">
        <div class="glass-card w-full max-w-sm p-6 text-center border-t-4 border-[#00d2ff]">
            <div class="w-16 h-16 bg-[#00d2ff]/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fab fa-telegram-plane text-3xl text-[#00d2ff]"></i>
            </div>
            <h2 class="text-xl font-bold mb-2 text-white">·ä•·äï·ä≥·äï ·ã∞·àÖ·äì ·àò·å°!</h2>
            <p class="text-xs text-gray-300 mb-6 leading-relaxed">·ã≠·àÖ·äï·äï ·àò·â∞·åç·â†·à™·ã´ ·àà·àò·å†·âÄ·àù ·ä•·â£·ä≠·ãé ·ã®·àö·ä®·â∞·àâ·âµ·äï ·âª·äì·àé·âΩ ·ã≠·âÄ·àã·âÄ·àâ·ç¢</p>
            
            <div id="requiredChannelsList" class="space-y-3 mb-6 max-h-48 overflow-y-auto pr-1">
                <!-- Channels will be injected here -->
            </div>

            <button onclick="verifyAllChannels()" class="btn-modern w-full py-3.5 shadow-lg">·àÅ·àâ·äï·àù ·â∞·âÄ·àã·âÖ·ã´·àà·àÅ (Verify)</button>
        </div>
    </div>

    <!-- Main App Content -->
    <div id="mainApp" class="hidden p-5 pt-8 max-w-md mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <img id="userPhoto" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="w-12 h-12 rounded-full border-2 border-white/20 object-cover shadow-lg">
                <div>
                    <h3 id="userName" class="font-bold text-lg leading-tight text-white">User</h3>
                    <p class="text-[11px] text-[#00d2ff] font-semibold bg-[#00d2ff]/10 px-2 rounded-full inline-block mt-0.5">Verified Account</p>
                </div>
            </div>
        </div>

        <div id="contentArea">
            <!-- HOME PAGE -->
            <div id="page-home" class="page-section">
                <div class="glass-card p-6 mb-6">
                    <p class="text-xs text-gray-300 uppercase tracking-widest mb-1">Total Balance</p>
                    <h2 class="text-4xl font-bold text-white mb-5">Birr <span id="balanceDisplay">0.00</span></h2>
                    <div class="flex justify-between items-end border-t border-white/10 pt-4">
                        <div>
                            <p class="text-[11px] text-gray-400">Total Refers</p>
                            <p class="text-lg font-bold text-[#00d2ff]" id="referDisplay">0</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div onclick="watchAd()" class="glass-card p-4 flex flex-col items-center justify-center cursor-pointer">
                        <i class="fas fa-play text-2xl text-[#00d2ff] mb-2"></i>
                        <span class="text-sm font-bold">Watch Ad</span>
                    </div>
                    <div onclick="navTo('withdraw')" class="glass-card p-4 flex flex-col items-center justify-center cursor-pointer">
                        <i class="fas fa-wallet text-2xl text-[#924eff] mb-2"></i>
                        <span class="text-sm font-bold">Withdraw</span>
                    </div>
                </div>

                <div class="glass-card p-5">
                    <h3 class="font-bold text-sm mb-3">Refer & Earn</h3>
                    <input type="text" id="refLink" readonly class="custom-input w-full p-3 rounded-lg text-xs mb-3 truncate">
                    <button onclick="copyRef()" class="btn-modern w-full py-2.5 text-xs">Copy Link</button>
                </div>
            </div>

            <!-- TASK PAGE -->
            <div id="page-task" class="page-section hidden">
                <h2 class="text-xl font-bold mb-5">Daily Tasks</h2>
                <div id="taskList" class="space-y-3 pb-20"></div>
            </div>

            <!-- WITHDRAW PAGE -->
            <div id="page-withdraw" class="page-section hidden">
                <h2 class="text-xl font-bold mb-5">Withdraw</h2>
                <div class="glass-card p-6">
                    <div class="space-y-4">
                        <select id="withdrawMethod" class="custom-input w-full p-4 rounded-xl text-sm">
                            <option value="Telebirr">Telebirr</option>
                            <option value="CBE">CBE</option>
                        </select>
                        <input type="number" id="withdrawNumber" placeholder="Account Number" class="custom-input w-full p-4 rounded-xl text-sm">
                        <input type="number" id="withdrawAmount" placeholder="Amount (Min 25)" class="custom-input w-full p-4 rounded-xl text-sm">
                        <button onclick="submitWithdraw()" class="btn-modern w-full py-4 shadow-lg">Request Withdrawal</button>
                    </div>
                </div>
            </div>

            <!-- LEADERBOARD PAGE -->
            <div id="page-leaderboard" class="page-section hidden">
                <h2 class="text-xl font-bold mb-5">Top Users</h2>
                <div id="leaderboardList" class="space-y-2 pb-24"></div>
            </div>

            <!-- ADMIN PAGE -->
            <div id="page-admin" class="page-section hidden pb-20">
                <h2 class="text-xl font-bold mb-5 text-grad">Admin Panel (Control)</h2>
                
                <!-- Manage Required Channels -->
                <div class="glass-card p-5 mb-5 border-l-4 border-yellow-500">
                    <h3 class="font-bold text-sm mb-3">üì¢ Join Gate ·âª·äì·àé·âΩ·äï ·àõ·àµ·â∞·ã≥·ã∞·à™·ã´</h3>
                    <div class="space-y-3 mb-4">
                        <input type="text" id="adminChanTitle" placeholder="Channel Name (e.g., Ethio News)" class="custom-input w-full p-3 rounded-lg text-xs">
                        <input type="text" id="adminChanUsername" placeholder="Username (e.g., @MyChannel)" class="custom-input w-full p-3 rounded-lg text-xs">
                        <input type="text" id="adminChanLink" placeholder="Link (e.g., https://t.me/...)" class="custom-input w-full p-3 rounded-lg text-xs">
                        <button onclick="addGateChannel()" class="btn-modern w-full py-2.5 text-xs">Add Mandatory Channel</button>
                    </div>
                    <div id="adminGateList" class="space-y-2 border-t border-white/10 pt-3"></div>
                </div>

                <!-- Manage Tasks -->
                <div class="glass-card p-5 mb-5">
                    <h3 class="font-bold text-sm mb-3">üí∞ ·ã®·åà·äï·ãò·â• ·àµ·à´·ãé·âΩ·äï ·àò·å´·äõ (Tasks)</h3>
                    <div class="space-y-3 mb-4">
                        <input type="text" id="adminTaskTitle" placeholder="Task Name" class="custom-input w-full p-3 rounded-lg text-xs">
                        <input type="text" id="adminTaskLink" placeholder="Link" class="custom-input w-full p-3 rounded-lg text-xs">
                        <input type="number" id="adminTaskReward" placeholder="Reward (Birr)" class="custom-input w-full p-3 rounded-lg text-xs">
                        <button onclick="addTask()" class="btn-modern w-full py-2.5 text-xs">Publish Task</button>
                    </div>
                </div>

                <!-- Withdrawals -->
                <div class="glass-card p-5">
                    <h3 class="font-bold text-sm mb-3">üí∏ Withdrawal Requests</h3>
                    <div id="adminWithdrawals" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div id="bottomNav" class="hidden fixed bottom-0 left-0 right-0 glass-nav py-3 px-6 flex justify-between items-center z-50">
        <div onclick="navTo('home')" class="nav-item active" id="nav-home"><i class="fas fa-home text-xl"></i><span class="text-[10px] block">Home</span></div>
        <div onclick="navTo('task')" class="nav-item" id="nav-task"><i class="fas fa-tasks text-xl"></i><span class="text-[10px] block">Tasks</span></div>
        <div onclick="navTo('leaderboard')" class="nav-item" id="nav-leaderboard"><i class="fas fa-trophy text-xl"></i><span class="text-[10px] block">Rank</span></div>
        <div onclick="navTo('admin')" class="nav-item hidden text-red-400" id="nav-admin"><i class="fas fa-user-shield text-xl"></i><span class="text-[10px] block">Admin</span></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const CONFIG = {
            botToken: "7475784251:AAEAussah1tDvDpsKG9OHPUsYUzSaHay7TY",
            botUsername: "Ethio_onlineworkbot",
            adminId: 7477735286, 
            adReward: 1.5,
            referReward: 2,
            minWithdraw: 25,
            firebase: {
                apiKey: "AIzaSyCbdzoJIoE7XJ5YFOi5lXc1P6FKkbGc5GI",
                authDomain: "ethio-88ff4.firebaseapp.com",
                projectId: "ethio-88ff4",
                databaseURL: "https://ethio-88ff4-default-rtdb.firebaseio.com", // ·å†·âÉ·àö·ç° ·ã≠·àÑ·äï ·ä•·à≠·åç·å†·äõ ·àÅ·äï
                storageBucket: "ethio-88ff4.firebasestorage.app",
                messagingSenderId: "605943052874",
                appId: "1:605943052874:web:b140890b278cf54ccec4b3"
            }
        };

        firebase.initializeApp(CONFIG.firebase);
        const db = firebase.database();
        const tg = window.Telegram.WebApp;
        let userData = {};
        let user = tg.initDataUnsafe.user || {id: 7477735286, first_name: "Admin", photo_url: ""};

        async function initApp() {
            // Loading Animation
            let prg = 0;
            const ring = document.getElementById('progressRing');
            const percent = document.getElementById('loadingPercent');
            const interval = setInterval(() => {
                prg += 5;
                if(prg > 100) {
                    clearInterval(interval);
                    document.getElementById('loadingScreen').style.display = 'none';
                }
                const offset = 251.2 - (prg / 100) * 251.2;
                ring.style.strokeDashoffset = offset;
                percent.innerText = prg + "%";
            }, 50);

            // Fetch User Data
            const snap = await db.ref(`users/${user.id}`).get();
            if(snap.exists()) {
                userData = snap.val();
            } else {
                userData = {id: user.id, firstName: user.first_name, balance: 0, referCount: 0, verified: false};
                await db.ref(`users/${user.id}`).set(userData);
            }

            // Show Admin Nav if user is Admin
            if(user.id == CONFIG.adminId) {
                document.getElementById('nav-admin').classList.remove('hidden');
            }

            // Check Verification
            if(userData.verified) {
                showApp();
            } else {
                loadGateChannels();
            }

            // Real-time Updates
            db.ref(`users/${user.id}`).on('value', s => {
                if(s.exists()) {
                    userData = s.val();
                    document.getElementById('balanceDisplay').innerText = (userData.balance || 0).toFixed(2);
                    document.getElementById('referDisplay').innerText = userData.referCount || 0;
                }
            });

            document.getElementById('userName').innerText = user.first_name;
            document.getElementById('userPhoto').src = user.photo_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
            document.getElementById('refLink').value = `https://t.me/${CONFIG.botUsername}?startapp=ref${user.id}`;
        }

        async function loadGateChannels() {
            const snap = await db.ref('gateChannels').get();
            const list = document.getElementById('requiredChannelsList');
            list.innerHTML = "";
            if(snap.exists()) {
                snap.forEach(c => {
                    const data = c.val();
                    list.innerHTML += `
                        <a href="${data.link}" target="_blank" class="flex justify-between items-center bg-white/5 p-3 rounded-xl border border-white/10 no-underline">
                            <span class="text-xs text-white"><i class="fab fa-telegram mr-2 text-blue-400"></i> ${data.title}</span>
                            <span class="text-[10px] bg-blue-500 px-2 py-1 rounded-lg text-white font-bold">JOIN</span>
                        </a>`;
                });
                document.getElementById('gateScreen').classList.remove('hidden');
            } else {
                // If no required channels, auto verify
                showApp();
            }
        }

        async function verifyAllChannels() {
            Swal.fire({title: 'Checking...', didOpen: () => Swal.showLoading(), background: '#1a1a2e', color: '#fff'});
            const snap = await db.ref('gateChannels').get();
            let allJoined = true;

            if(snap.exists()) {
                for(let key in snap.val()){
                    const chan = snap.val()[key];
                    try {
                        const res = await fetch(`https://api.telegram.org/bot${CONFIG.botToken}/getChatMember?chat_id=${chan.username}&user_id=${user.id}`);
                        const d = await res.json();
                        if(!d.ok || !["creator", "administrator", "member"].includes(d.result.status)) {
                            allJoined = false;
                            break;
                        }
                    } catch(e) { allJoined = false; }
                }
            }

            if(allJoined) {
                await db.ref(`users/${user.id}`).update({verified: true});
                Swal.fire({icon: 'success', title: 'Verified!', background: '#1a1a2e', color: '#fff', timer: 1500});
                document.getElementById('gateScreen').classList.add('hidden');
                showApp();
            } else {
                Swal.fire({icon: 'error', title: '·ã´·àç·â∞·âÄ·àã·âÄ·àâ·âµ ·âª·äì·àç ·ä†·àà!', text: '·ä•·â£·ä≠·ãé ·àÅ·àâ·äï·àù ·âª·äì·àé·âΩ ·ã≠·âÄ·àã·âÄ·àâ', background: '#1a1a2e', color: '#fff'});
            }
        }

        function showApp() {
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('bottomNav').classList.remove('hidden');
            loadTasks();
        }

        window.navTo = (p) => {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${p}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${p}`).classList.add('active');
            if(p === 'leaderboard') loadLeaderboard();
            if(p === 'admin') loadAdminData();
        };

        // --- ADMIN FUNCTIONS ---
        async function addGateChannel() {
            const title = document.getElementById('adminChanTitle').value;
            const username = document.getElementById('adminChanUsername').value;
            const link = document.getElementById('adminChanLink').value;
            if(title && username && link) {
                await db.ref('gateChannels').push({title, username, link});
                document.getElementById('adminChanTitle').value = "";
                loadAdminData();
                Swal.fire({toast:true, icon:'success', title: 'Channel Added'});
            }
        }

        async function loadAdminData() {
            // Gate Channels
            const gateList = document.getElementById('adminGateList');
            const snap = await db.ref('gateChannels').get();
            gateList.innerHTML = "";
            if(snap.exists()) {
                snap.forEach(c => {
                    gateList.innerHTML += `<div class="bg-white/5 p-2 rounded flex justify-between text-[10px]">
                        <span>${c.val().title} (${c.val().username})</span>
                        <button onclick="deleteGateChan('${c.key}')" class="text-red-400">Delete</button>
                    </div>`;
                });
            }
            loadAdminWithdrawals();
        }

        window.deleteGateChan = async (key) => {
            await db.ref(`gateChannels/${key}`).remove();
            loadAdminData();
        };

        async function addTask() {
            const title = document.getElementById('adminTaskTitle').value;
            const link = document.getElementById('adminTaskLink').value;
            const reward = parseFloat(document.getElementById('adminTaskReward').value);
            if(title && link && reward) {
                await db.ref('tasks').push({title, link, reward});
                Swal.fire({icon:'success', title:'Task Published'});
                loadTasks();
            }
        }

        async function loadTasks() {
            const list = document.getElementById('taskList');
            const snap = await db.ref('tasks').get();
            list.innerHTML = "";
            if(snap.exists()){
                snap.forEach(t => {
                    list.innerHTML += `<div class="glass-card p-4 flex justify-between items-center">
                        <div><p class="font-bold text-sm">${t.val().title}</p><p class="text-xs text-blue-400">+${t.val().reward} Birr</p></div>
                        <button onclick="window.open('${t.val().link}')" class="bg-white/10 px-4 py-2 rounded-lg text-xs">Start</button>
                    </div>`;
                });
            }
        }

        async function submitWithdraw() {
            const amt = parseFloat(document.getElementById('withdrawAmount').value);
            const num = document.getElementById('withdrawNumber').value;
            const method = document.getElementById('withdrawMethod').value;
            
            if(amt >= CONFIG.minWithdraw && userData.balance >= amt) {
                await db.ref(`users/${user.id}`).update({balance: userData.balance - amt});
                await db.ref('withdrawals').push({
                    uid: user.id, name: user.first_name, amount: amt, number: num, method: method, status: 'pending'
                });
                Swal.fire({icon:'success', title:'Requested!'});
            } else {
                Swal.fire({icon:'error', title:'Insufficient Balance or Min Limit!'});
            }
        }

        async function loadAdminWithdrawals() {
            const div = document.getElementById('adminWithdrawals');
            const snap = await db.ref('withdrawals').get();
            div.innerHTML = "";
            if(snap.exists()){
                snap.forEach(w => {
                    if(w.val().status === 'pending') {
                        div.innerHTML += `<div class="bg-white/5 p-3 rounded-lg text-xs">
                            <p>${w.val().name} - ${w.val().amount} Birr (${w.val().method})</p>
                            <p class="text-gray-400 mb-2">${w.val().number}</p>
                            <button onclick="approveWithdraw('${w.key}')" class="bg-green-600 px-3 py-1 rounded">Approve</button>
                        </div>`;
                    }
                });
            }
        }

        window.approveWithdraw = async (key) => {
            await db.ref(`withdrawals/${key}`).update({status: 'paid'});
            loadAdminWithdrawals();
        };

        window.copyRef = () => {
            const el = document.getElementById('refLink');
            el.select();
            document.execCommand('copy');
            Swal.fire({toast:true, title: 'Copied!', timer:1000});
        };

        initApp();
    </script>
</body>
</html>
